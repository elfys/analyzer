# Contains a set of instructions for a single chip IV measurement on Keithley SMU 2636 (Innopoli)

instruments:
  temperature_resource: "PT100MK1-1DCBA1.temperature"
  pyvisa:
    resource: "GPIB0::1::INSTR"
    name: "Keithley SMU 2636 (Innopoli)"
    invert_voltage: true
    kwargs:
      timeout: 10000


measure:
  - command: "smua.trigger.initiate()"
    type: "write"
  - command: "waitcomplete()"
    type: "write"
  - command: "smua.source.output = smua.OUTPUT_OFF"
    type: "write"
  - command: "printbuffer(1, smua.nvbuffer1.n, smua.nvbuffer1.readings)"
    type: "query_csv_values"
    name: anode_current
  - command: "printbuffer(1, smua.nvbuffer1.n, smua.nvbuffer1.sourcevalues)"
    type: "query_csv_values"
    name: voltage_input

chips:
  - voltage_input: voltage_input
    anode_current: anode_current


measurements:
  - name: 20v
    instrument:
      - "reset()" # resets commands to their default settings
      - "smua.source.func = smua.OUTPUT_DCVOLTS" # selects the voltage source function
      - "smua.source.autorangev = smua.AUTORANGE_ON" # enables voltage source autorange
      - "smua.source.autorangei = smua.AUTORANGE_ON" # enables current source autorange (delete?)
      - "smua.source.output = smua.OUTPUT_ON" # turn on the output in preparation for the sweep
      #- "smua.source.limiti = 10e-3" # comlience limit
      - "smua.measure.nplc = 1" # sets the integration time. 0.01 - fast, 0.1 - med, 1 - normal
      - "smua.measure.autozero = smua.AUTOZERO_OFF" # disables automatic updates to the internal reference measurements of the instrument
      - "smua.measure.lowrangei=1e-9" # sets the lowest measurement range that is used when the instruments is autoranging
      - "vlist = {2,1,0.01,0,-0.01,-1,-2,-3,-4,-5,-6,-7,-8,-9,-10}" # sets the voltage list
      - "points = 15" # counts the point
      #- "stime = 200e-3" # time delay between points

      # Buffer
      - "smua.nvbuffer1.clear()" # clear the buffer
      - "smua.nvbuffer1.appendmode = 1" # saves measurement to buffer
      - "smua.nvbuffer1.collecttimestamps = 1" # saves timestamps
      - "smua.nvbuffer1.collectsourcevalues = 1 " # source values are stored with readings in the buffer

      # Trigger the measurement
      - "trigger.timer[1].reset()" # resets the attributes associated with timer 1 back to the factory default values. Timers perform a delay
      - "trigger.timer[1].stimulus = smua.trigger.SOURCE_COMPLETE_EVENT_ID" # smu completes a source action
#      - "trigger.timer[1].delay = stime" # delay interval
      - "smua.trigger.arm.count = 1" # number of times to perform sweep
      - "smua.trigger.source.listv(vlist)" # sweeps  smuA through vlist
      - "smua.trigger.source.action = smua.ENABLE" # enables the source action
      - "smua.trigger.endpulse.action = smua.SOURCE_HOLD"
      - "smua.trigger.measure.i(smua.nvbuffer1)" # stores current readings during the sweep in buffer
      - "smua.trigger.measure.action = smua.ENABLE" # makes measurement during the sweep
      - "smua.trigger.measure.stimulus = trigger.timer[1].EVENT_ID" # identifies events generated by the timer
      - "smua.trigger.count = points" # number of points to output
    program:
      validation:
        anode_current[-1]:
          min:
            abs: true
            value: !!float 5e-3
            message: Current leakage is too low. Check if there is a good contact.
      measurements_kwargs:
        int_time: LONG
